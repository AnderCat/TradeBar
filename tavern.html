<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>çµæ§‹é…’é¤¨ï½œSNR ä¿®è¡Œä»»å‹™æ¿</title>
    <style>
        :root {
            --bg0: #0b0f14;
            --bg1: #101826;
            --wood0: #2a1a12;
            --wood1: #3a2419;
            --ink: #e8e1d7;
            --muted: #b7ad9f;
            --gold: #f7c65f;
            --red: #ff6b6b;
            --green: #7dff9b;
            --blue: #7db7ff;
            --shadow: rgba(0, 0, 0, .45);
            --card: rgba(16, 24, 38, 0.55);
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            min-height: 100svh;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
            color: var(--ink);
            background:
                /* æš–è‰²ç‡­å…‰é®ç½©ï¼ˆå¾ˆé‡è¦ï¼‰ */
                linear-gradient(rgba(40, 25, 15, 0.75),
                    rgba(40, 25, 15, 0.75)),
                url("background.jpg");
            /* â† æ›æˆä½ çš„åœ–ç‰‡æª”å */

            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* æœ‰é…’é¤¨ç‰†é¢çš„ç©©å®šæ„Ÿ */
            overflow-x: hidden;
        }

        /* faux tavern particles */
        .embers {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background:
                radial-gradient(1px 1px at 10% 30%, rgba(247, 198, 95, .55), transparent 60%),
                radial-gradient(1px 1px at 40% 60%, rgba(247, 198, 95, .35), transparent 60%),
                radial-gradient(1px 1px at 75% 45%, rgba(247, 198, 95, .45), transparent 60%),
                radial-gradient(1px 1px at 55% 20%, rgba(247, 198, 95, .28), transparent 60%),
                radial-gradient(1px 1px at 85% 75%, rgba(247, 198, 95, .20), transparent 60%);
            opacity: .9;
            filter: blur(.1px);
            animation: float 10s linear infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0)
            }

            100% {
                transform: translateY(-30px)
            }
        }

        header {
            padding: 22px 18px 10px;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 16px;
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .brand h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: .08em;
        }

        .brand .sub {
            color: var(--muted);
            font-size: 13px;
            line-height: 1.4;
        }

        .hud {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .pill {
            background: rgba(0, 0, 0, .22);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 999px;
            padding: 10px 12px;
            min-width: 160px;
            box-shadow: 0 12px 30px var(--shadow);
            backdrop-filter: blur(6px);
        }

        .pill .k {
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .pill .v {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-weight: 700;
        }

        .bar {
            height: 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .06);
            overflow: hidden;
            flex: 1;
        }

        .fill {
            height: 100%;
            width: 50%;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(247, 198, 95, .95), rgba(247, 198, 95, .45));
        }

        .fill.hp {
            background: linear-gradient(90deg, rgba(255, 107, 107, .95), rgba(255, 107, 107, .45));
        }

        .fill.good {
            background: linear-gradient(90deg, rgba(125, 255, 155, .95), rgba(125, 255, 155, .45));
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 18px 28px;
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 16px;
        }

        @media (max-width: 980px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        /* bartender card */
        .bartender {
            position: relative;
            background: linear-gradient(180deg, rgba(58, 36, 25, .55), rgba(16, 24, 38, .55));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 18px;
            padding: 16px 16px 14px;
            box-shadow: 0 18px 50px var(--shadow);
            overflow: hidden;
        }

        .bartender:before {
            content: "";
            position: absolute;
            inset: -50px -60px auto auto;
            width: 180px;
            height: 180px;
            background: radial-gradient(circle at 30% 30%, rgba(247, 198, 95, .25), transparent 65%);
            transform: rotate(20deg);
        }

        .portrait {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 10px;
        }

        .face {
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, .1);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .35);
            position: relative;
            overflow: hidden;
            width: 64px;
            height: 64px;
            background: rgba(0, 0, 0, .3);
        }

        .face img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
            /* ä¸è®Šå½¢ï¼Œè£åˆ‡å¡«æ»¿ */
        }

        /* simple silhouette */
        .face:before {
            content: "";
            position: absolute;
            inset: 10px 12px 12px 12px;
            border-radius: 14px 14px 18px 18px;
            background: linear-gradient(180deg, rgba(232, 225, 215, .22), rgba(232, 225, 215, .06));
            filter: drop-shadow(0 10px 18px rgba(0, 0, 0, .35));
        }

        .face:after {
            content: "";
            position: absolute;
            left: 12px;
            right: 12px;
            top: 10px;
            height: 22px;
            border-radius: 14px 14px 10px 10px;
            background: linear-gradient(180deg, rgba(0, 0, 0, .35), transparent);
            opacity: .75;
        }

        .portrait .who {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .portrait .who .name {
            font-weight: 800;
            letter-spacing: .06em;
        }

        .portrait .who .role {
            color: var(--muted);
            font-size: 12px;
        }

        .npc {
            color: rgba(232, 225, 215, .92);
            font-size: 13px;
            line-height: 1.55;
            margin: 8px 0 12px;
        }

        .controls {
            display: grid;
            gap: 10px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .field {
            background: rgba(0, 0, 0, .22);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 14px;
            padding: 10px 10px;
        }

        label {
            display: block;
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 6px;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 10px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(16, 24, 38, .50);
            color: var(--ink);
            outline: none;
        }

        .checkline {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(16, 24, 38, .50);
            user-select: none;
            cursor: pointer;
        }

        .checkline input {
            width: 16px;
            height: 16px;
        }

        .btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 2px;
        }

        button {
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(0, 0, 0, .25);
            color: var(--ink);
            padding: 10px 12px;
            border-radius: 14px;
            cursor: pointer;
            transition: transform .06s ease, background .2s ease;
            box-shadow: 0 14px 30px var(--shadow);
        }

        button:hover {
            background: rgba(0, 0, 0, .35);
        }

        button:active {
            transform: translateY(1px);
        }

        .danger {
            border-color: rgba(255, 107, 107, .35);
        }

        .gold {
            border-color: rgba(247, 198, 95, .35);
        }

        /* quest board */
        .board {
            background: linear-gradient(180deg, rgba(42, 26, 18, .55), rgba(16, 24, 38, .55));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 18px 50px var(--shadow);
            overflow: hidden;
            position: relative;
        }

        .board:before {
            content: "";
            position: absolute;
            inset: -60px -80px auto auto;
            width: 240px;
            height: 240px;
            background: radial-gradient(circle at 30% 30%, rgba(125, 183, 255, .10), transparent 65%);
            transform: rotate(18deg);
        }

        .board h2 {
            margin: 0 0 12px;
            font-size: 16px;
            letter-spacing: .08em;
            color: rgba(232, 225, 215, .95);
        }

        .cols {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 980px) {
            .cols {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(0, 0, 0, .20);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 16px;
            padding: 12px;
            min-height: 210px;
            position: relative;
            overflow: hidden;
        }

        .panel .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
            letter-spacing: .06em;
            margin-bottom: 8px;
        }

        .tag .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: var(--gold);
            box-shadow: 0 0 20px rgba(247, 198, 95, .22);
        }

        .tag.daily .dot {
            background: var(--green);
        }

        .tag.ongoing .dot {
            background: var(--blue);
        }

        .tag.bounty .dot {
            background: var(--red);
        }

        .quest {
            border: 1px dashed rgba(255, 255, 255, .12);
            border-radius: 14px;
            padding: 10px;
            margin-top: 10px;
            background: rgba(16, 24, 38, .30);
        }

        .quest .title {
            font-weight: 800;
            margin-bottom: 6px;
        }

        .quest .desc {
            color: var(--muted);
            font-size: 12px;
            line-height: 1.45;
            margin-bottom: 8px;
        }

        .quest .meta {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            font-size: 12px;
            color: rgba(232, 225, 215, .85);
        }

        .small {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.45;
        }

        footer {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 18px 26px;
            color: rgba(232, 225, 215, .60);
            font-size: 12px;
        }

        .kbd {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            background: rgba(0, 0, 0, .25);
            border: 1px solid rgba(255, 255, 255, .08);
            padding: 2px 6px;
            border-radius: 8px;
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stepper-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(0, 0, 0, .25);
            color: var(--ink);
            cursor: pointer;
            font-size: 18px;
            font-weight: 800;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .stepper-btn:hover {
            background: rgba(0, 0, 0, .35);
        }

        .stepper-btn:active {
            transform: translateY(1px);
        }

        .stepper input#btCount {
            text-align: center;
            width: 100%;
            flex: 1;
        }

        /* ç§»é™¤ number input çš„ä¸Šä¸‹ç®­é ­ï¼ˆChrome, Edge, Safariï¼‰ */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #npcLine { white-space: pre-line; }
    </style>
</head>

<body>
    <div class="embers" aria-hidden="true"></div>

    <header>
        <div class="brand">
            <h1>çµæ§‹é…’é¤¨ï½œSNR ä¿®è¡Œä»»å‹™æ¿</h1>
            <div class="sub">æ¯å¤©æª¢æŸ¥ä¸€æ¬¡ã€‚ä¸æ˜¯é å¿ƒæƒ…åšäº¤æ˜“ï¼Œæ˜¯é çµæ§‹æ´»ä¸‹ä¾†ã€‚</div>
        </div>

        <div class="hud">
            <div class="pill" id="pillLevel">
                <div class="k"><span>ç­‰ç´š</span><span id="titleBadge">è¦‹ç¿’äº¤æ˜“è€…</span></div>
                <div class="v"><span id="levelVal">1</span><span class="small" id="xpToNext">è·é›¢ä¸‹ç´šï¼š20 XP</span></div>
            </div>

            <div class="pill">
                <div class="k"><span>XP</span><span id="xpVal">0</span></div>
                <div class="v">
                    <div class="bar" title="XP é€²åº¦">
                        <div class="fill" id="xpFill"></div>
                    </div>
                    <span id="xpPct" class="small">0%</span>
                </div>
            </div>

            <div class="pill" id="hpPill">
                <div class="k"><span>HP</span><span id="hpVal">100</span></div>
                <div class="v">
                    <div class="bar" title="HP">
                        <div class="fill hp" id="hpFill"></div>
                    </div>
                    <span id="hpState" class="small">å®‰å…¨</span>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="bartender">
            <div class="portrait">
                <div class="face" aria-hidden="true">
                    <img src="face.png" alt="é…’é¤¨è€é—†" />
                </div>
                <div class="who">
                    <div class="name">é…’é¤¨è€é—†</div>
                    <div class="role">ä»»å‹™ç™¼æ”¾è€…ï½œè¦å‰‡å®ˆé–€äºº</div>
                </div>
            </div>

            <div class="npc" id="npcLine">
                ã€Œå†’éšªè€…ã€‚ä»Šå¤©åªè¦åšä¸€ä»¶æ­£ç¢ºçš„äº‹ï¼Œå°±ç®—æ´»è‘—ã€‚ã€
            </div>

            <div class="controls">
                <div class="row">
                    <div class="field">
                        <label for="btCount">ä»Šæ—¥å›æ¸¬ç­†æ•¸</label>
                        <div class="stepper">
                            <button type="button" id="btMinus" class="stepper-btn" aria-label="å›æ¸¬ç­†æ•¸æ¸›å°‘">âˆ’</button>
                            <input id="btCount" type="number" min="0" step="1" value="0" inputmode="numeric" />
                            <button type="button" id="btPlus" class="stepper-btn" aria-label="å›æ¸¬ç­†æ•¸å¢åŠ ">ï¼‹</button>
                        </div>
                    </div>
                    <div class="field">
                        <label for="liveNote">ç›´æ’­ç­†è¨˜</label>
                        <select id="liveNote">
                            <option value="none">ç„¡</option>
                            <option value="full">æœ‰</option>
                        </select>
                    </div>
                </div>

                <div class="field">
                    <label>ä»Šæ—¥æ˜¯å¦æƒ…ç·’å–® / éè¦å‰‡å–®</label>
                    <div class="checkline" id="emoWrap">
                        <input id="emoTrade" type="checkbox" />
                        <span>æœ‰ï¼ˆæ‰£è¡€å¾ˆé‡ï¼Œåˆ¥äº‚å‹¾ï¼‰</span>
                    </div>
                </div>

                <div class="btns">
                    <button class="gold" id="btnGetQuests">é ˜å–ä»Šæ—¥ä»»å‹™</button>
                    <button id="btnReport">å›å ±å®Œæˆï¼ˆè¨ˆå…¥ä»Šæ—¥ï¼‰</button>
                    <button class="danger" id="btnEndDay">çµæŸä»Šæ—¥ï¼ˆæ¯æ—¥æª¢æŸ¥ / æ‰£è¡€ï¼‰</button>
                    <button id="btnReset">é‡ç½®å­˜æª”</button>
                    <button id="btnClaim">å·²é ˜å–çå‹µï¼ˆæ¸…ç©ºå¾…é ˜ï¼‰</button>
                </div>

                <div class="small">
                    æç¤ºï¼šä½ å¯ä»¥æŠŠé€™é ç•¶æˆã€Œé…’é¤¨æ«ƒå°ã€ã€‚<br>
                    æµç¨‹ï¼š<span class="kbd">é ˜ä»»å‹™</span> â†’ åšäº‹ â†’ <span class="kbd">å›å ±å®Œæˆ</span> â†’ æ¯å¤©ä¸€æ¬¡æŒ‰ <span
                        class="kbd">çµæŸä»Šæ—¥</span>ã€‚
                </div>
            </div>
        </section>

        <section class="board">
            <h2>ä»»å‹™å…¬å‘Šæ¿</h2>

            <div class="cols">
                <div class="panel">
                    <div class="tag daily"><span class="dot"></span><span>æ¯æ—¥ä»»å‹™</span></div>
                    <div id="dailySlot"></div>
                </div>

                <div class="panel">
                    <div class="tag ongoing"><span class="dot"></span><span>ä¿®è¡Œä»»å‹™ï¼ˆä¸»ç·šï¼‰</span></div>
                    <div id="ongoingSlot"></div>
                </div>

                <div class="panel">
                    <div class="tag bounty"><span class="dot"></span><span>è¨ä¼ä»»å‹™ï¼ˆè§¸ç™¼ï¼‰</span></div>
                    <div id="bountySlot"></div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div>æœ¬åœ°å­˜æª”ï¼šä½¿ç”¨ç€è¦½å™¨ LocalStorageï¼ˆä¸æœƒä¸Šå‚³ï¼‰ã€‚</div>
    </footer>

    <script>
        (() => {
            /** ---------- State ---------- */
            const STORE_KEY = "tavern_snr_state_v1";

            const defaultState = () => ({
                xp: 0,
                level: 1,
                hp: 100,
                // today inputs
                today: { bt: 0, live: "none", emo: false },
                // quests
                quests: {
                    daily: [],
                    ongoing: {
                        id: "chain-structure-1",
                        title: "ğŸ§©ã€Šçµæ§‹ç†è§£ Iã€‹",
                        desc: "å®Œæˆ 20 ç­† SNR å›æ¸¬ï¼ˆç´¯ç©ï¼‰ã€‚",
                        target: 20,
                        progress: 0,
                        reward: "å®Œæˆï¼š+40 XP / +20 HP",
                    },
                    bounty: null
                },
                // bookkeeping
                dayCount: 0,
                lastReportHash: "",
                pendingRewards: [],
            });

            let state = loadState();

            /** ---------- DOM ---------- */
            const $ = (id) => document.getElementById(id);

            const btCount = $("btCount");
            const btMinus = $("btMinus");
            const btPlus = $("btPlus");
            const liveNote = $("liveNote");
            const emoTrade = $("emoTrade");
            const emoWrap = $("emoWrap");

            const dailySlot = $("dailySlot");
            const ongoingSlot = $("ongoingSlot");
            const bountySlot = $("bountySlot");

            const btnGetQuests = $("btnGetQuests");
            const btnReport = $("btnReport");
            const btnEndDay = $("btnEndDay");
            const btnReset = $("btnReset");

            const levelVal = $("levelVal");
            const titleBadge = $("titleBadge");
            const xpVal = $("xpVal");
            const xpFill = $("xpFill");
            const xpPct = $("xpPct");
            const xpToNext = $("xpToNext");

            const hpVal = $("hpVal");
            const hpFill = $("hpFill");
            const hpState = $("hpState");
            const hpPill = $("hpPill");

            const npcLine = $("npcLine");

            /** ---------- Rules ---------- */
            function xpFromToday(t) {
                const btXP = t.bt * 3;
                const liveXP = (t.live === "full") ? 10 : (t.live === "fuzzy") ? 5 : 0;
                return btXP + liveXP;
            }

            function hpDeltaEndOfDay(t) {
                // strict A rules: no backtest => -15; emo => -25; live without notes => -10
                let d = 0;
                if (t.emo) d -= 25;
                if (t.bt === 0) d -= 15;
                return d;
            }

            function hpHealFromActions(t) {
                // heal is only for correct actions; used when reporting completion (not end day)
                // backtest 3 => +5 HP (floor)
                const heals = Math.floor(t.bt / 3) * 5;
                const liveHeal = (t.live === "full") ? 10 : 0;
                return heals + liveHeal;
            }

            function levelNeedXPForNext(level) {
                // per your staged curve:
                // Lv1-10: each level needs 20
                // Lv11-30: 30 + level*2
                // Lv31-70: 120 + level*3
                // Lv71-120: 300 + level*5 (not used here)
                if (level <= 10) return 20;
                if (level <= 30) return 30 + level * 2;
                if (level <= 70) return 120 + level * 3;
                return 300 + level * 5;
            }

            function titleForLevel(level) {
                if (level < 10) return "è¦‹ç¿’äº¤æ˜“è€…";
                if (level < 30) return "äº¤æ˜“å­¸å¾’";
                if (level < 70) return "äº¤æ˜“å¤§å¸«";
                return "äº¤æ˜“å®—å¸«";
            }

            function rewardHint(level) {
                // simplified; you can expand
                if (level === 5) return "ğŸ¬ NT$100â€“200";
                if (level === 10) return "ğŸ° NT$300â€“500ï¼ˆè½‰è·å®Œæˆå¾Œç²å¾—ï¼‰";
                if (level === 15) return "ğŸ¬ NT$100â€“200";
                if (level === 20) return "ğŸ° NT$300â€“500";
                if (level === 25) return "ğŸ¬ NT$100â€“200";
                if (level === 30) return "ğŸ† NT$800â€“1200ï¼ˆè½‰è·å®Œæˆå¾Œç²å¾—ï¼‰";
                if (level === 35) return "ğŸ¬ NT$200â€“300";
                if (level === 40) return "ğŸ° NT$600â€“800";
                if (level === 45) return "ğŸ¬ NT$200â€“300";
                if (level === 50) return "ğŸ° NT$1200â€“1500";
                if (level === 55) return "ğŸ¬ NT$300â€“400";
                if (level === 60) return "ğŸ° NT$800â€“1000";
                if (level === 65) return "ğŸ¬ NT$300â€“400";
                if (level === 70) return "ğŸ† NT$2000â€“3000ï¼ˆè½‰è·å®Œæˆå¾Œç²å¾—ï¼‰";
                return "â€”";
            }

            /** ---------- Quest System ---------- */
            const DAILY_POOL = [
                {
                    id: "daily-structure-3",
                    title: "ğŸ“˜ çµæ§‹è§€å¯Ÿ",
                    desc: "å›æ¸¬ 3 ç­†ï¼ˆå®Œæ•´ç´€éŒ„ï¼‰ã€‚",
                    check: (t) => t.bt >= 3,
                    rewardText: "+3 XP",
                    xpReward: 3,
                    done: false
                },
                {
                    id: "daily-structure-1",
                    title: "ğŸ“Œ åªåšä¸€ç­†",
                    desc: "å›æ¸¬ 1 ç­†ï¼Œä¸èƒ½æŒ‘ç°¡å–®çš„ã€‚",
                    check: (t) => t.bt >= 1,
                    rewardText: "+1 XP",
                    xpReward: 1,
                    done: false
                },
                {
                    id: "daily-live-full",
                    title: "ğŸ•¯ï¸ é…’é¤¨è½èª²",
                    desc: "çœ‹ 1 å ´ç›´æ’­ä¸¦å¯«å®Œæ•´ç­†è¨˜ã€‚",
                    check: (t) => t.live === "full",
                    rewardText: "+10 XP",
                    xpReward: 10,
                    done: false
                },
                {
                    id: "daily-no-trade",
                    title: "ğŸ˜ åªçœ‹ä¸åš",
                    desc: "çœ‹ç›¤ 10 åˆ†é˜ï¼Œä¸ä¸‹å–®ï¼ˆç”¨èª å¯¦å‹¾é¸ï¼‰ã€‚",
                    check: (t) => true, // honor-based, we won't track time
                    rewardText: "+3 XP",
                    xpReward: 3,
                    done: false
                }
            ];

            const btnClaim = document.getElementById("btnClaim");
            btnClaim.addEventListener("click", () => {
                if (!state.pendingRewards.length) return toast("ç›®å‰æ²’æœ‰å¾…é ˜çå‹µã€‚");
                state.pendingRewards = [];
                saveState();
                renderHUD();
                toast("ğŸ å·²æ¸…ç©ºå¾…é ˜çå‹µã€‚");
            });


            function pickDailyQuests() {
                // pick 2 distinct
                const pool = [...DAILY_POOL];
                shuffle(pool);
                return pool.slice(0, 2);
            }

            function maybeSpawnBounty() {
                // Trigger conditions:
                // hp <= 40 OR 2 days without backtest not tracked; here we use hp only for demo.
                if (state.hp <= 40) {
                    return {
                        id: "bounty-fog",
                        title: "â˜ ï¸ã€Šæ‡¶æƒ°ä¹‹éœ§ã€‹",
                        desc: "é€£çºŒ 3 å¤©ï¼Œæ¯å¤©è‡³å°‘å›æ¸¬ 1 ç­†ï¼ˆæœ¬ Demo ä»¥ã€æ¥ä¸‹ä¾† 3 æ¬¡çµæŸä»Šæ—¥ã€æ¨¡æ“¬ï¼‰ã€‚",
                        target: 3,
                        progress: state.quests.bounty?.id === "bounty-fog" ? state.quests.bounty.progress : 0,
                        reward: "å®Œæˆï¼šHP å›æ»¿ +25 XPï¼ˆæ‰‹å‹•è§¸ç™¼ï¼‰"
                    };
                }
                return null;
            }

            /** ---------- Actions ---------- */
            function loadState() {
                try {
                    const raw = localStorage.getItem(STORE_KEY);
                    if (!raw) return defaultState();
                    const parsed = JSON.parse(raw);
                    // shallow merge
                    return { ...defaultState(), ...parsed, today: { ...defaultState().today, ...(parsed.today || {}) } };
                } catch {
                    return defaultState();
                }
            }

            function saveState() {
                localStorage.setItem(STORE_KEY, JSON.stringify(state));
            }

            function syncInputsFromState() {
                btCount.value = state.today.bt;
                liveNote.value = state.today.live;
                emoTrade.checked = state.today.emo;
            }

            function syncStateFromInputs() {
                state.today.bt = clampInt(btCount.value, 0, 9999);
                state.today.live = liveNote.value;
                state.today.emo = !!emoTrade.checked;
            }

            function renderHUD() {
                levelVal.textContent = String(state.level);
                titleBadge.textContent = titleForLevel(state.level);
                xpVal.textContent = String(state.xp);

                const need = levelNeedXPForNext(state.level);
                const intoLevel = xpIntoCurrentLevel(); // xp accumulated since reaching this level
                const pct = Math.max(0, Math.min(100, (intoLevel / need) * 100));
                xpFill.style.width = pct + "%";
                xpPct.textContent = Math.round(pct) + "%";
                xpToNext.textContent = `è·é›¢ä¸‹ç´šï¼š${Math.max(0, need - intoLevel)} XP`;

                hpVal.textContent = String(state.hp);
                hpFill.style.width = (state.hp / 100) * 100 + "%";

                const st = state.hp <= 20 ? "ç€•æ­»" : state.hp <= 40 ? "å±éšª" : state.hp <= 70 ? "è­¦æˆ’" : "å®‰å…¨";
                hpState.textContent = st;
                hpPill.classList.toggle("danger", state.hp <= 40);

                const pendingText = state.pendingRewards.length
                    ? "å¾…é ˜ï¼š" + state.pendingRewards.map(r => `Lv.${r.level} ${r.hint}`).join("ã€")
                    : "";
                const hint = rewardHint(state.level);
                npcLine.textContent =
                    state.hp <= 40
                        ? `ã€Œä½ èº«ä¸Šæœ‰è¡€å‘³ã€‚å…ˆåˆ¥é€å¼·â€”â€”å»è¨ä¼ã€æ‡¶æƒ°ä¹‹éœ§ã€ã€‚ã€`
                        : hint !== "â€”"
                            ? `ã€Œç›®å‰çå‹µï¼š ä½ å¯ä»¥ç²å¾— ${hint} è‡ªé¸çå“ã€‚ã€`
                            : `ã€Œå†’éšªè€…ã€‚ä»Šå¤©åªè¦åšä¸€ä»¶æ­£ç¢ºçš„äº‹ï¼Œå°±ç®—æ´»è‘—ã€‚ã€`;
                npcLine.textContent = (npcLine.textContent + (pendingText ? `\r\n${pendingText}` : ""));
            }

            function xpIntoCurrentLevel() {
                // Compute XP consumed by previous levels (rough, based on same curve)
                let consumed = 0;
                for (let lv = 1; lv < state.level; lv++) {
                    consumed += levelNeedXPForNext(lv);
                }
                return state.xp - consumed;
            }

            function tryLevelUp() {
                // multi-level up if huge XP
                let leveled = false;
                while (true) {
                    const need = levelNeedXPForNext(state.level);
                    if (xpIntoCurrentLevel() >= need) {
                        state.level += 1;
                        state.hp = 100; // on level up, refill HP
                        leveled = true;
                        // on important milestones, you could show a popup; we'll just alert.
                        const hint = rewardHint(state.level);
                        if (hint !== "â€”") {
                            const already = state.pendingRewards.some(r => r.level === state.level);
                            if (!already) state.pendingRewards.push({ level: state.level, hint });
                        }
                        if (hint !== "â€”") toast(`ğŸ‰ å‡ç­‰åˆ° Lv.${state.level}ï¼çå‹µï¼š${hint}`);
                        else toast(`ğŸ‰ å‡ç­‰åˆ° Lv.${state.level}ï¼HP å›æ»¿ã€‚`);
                    } else break;
                }
                return leveled;
            }

            function renderBoard() {
                // daily
                dailySlot.innerHTML = "";
                if (!state.quests.daily.length) {
                    dailySlot.innerHTML = `<div class="small">å°šæœªé ˜å–ã€‚æŒ‰ã€Œé ˜å–ä»Šæ—¥ä»»å‹™ã€ã€‚</div>`;
                } else {
                    state.quests.daily.forEach(q => dailySlot.appendChild(questCard(q, "daily")));
                }

                // ongoing
                ongoingSlot.innerHTML = "";
                ongoingSlot.appendChild(questCard(state.quests.ongoing, "ongoing", true));

                // bounty
                bountySlot.innerHTML = "";
                if (!state.quests.bounty) {
                    bountySlot.innerHTML = `<div class="small">ç›®å‰æ²’æœ‰è¨ä¼ä»»å‹™ï¼ˆä¿æŒ HP > 40ï¼‰ã€‚</div>`;
                } else {
                    bountySlot.appendChild(questCard(state.quests.bounty, "bounty", true));
                }
            }

            function questCard(q, kind, showProgress = false) {
                const el = document.createElement("div");
                el.className = "quest";

                // daily çš„å®Œæˆç‹€æ…‹ï¼ˆæ²’æœ‰å°±ç•¶ falseï¼‰
                const done = !!q.done;

                const prog = showProgress && q.target ? `${q.progress}/${q.target}` : "";
                const metaLeft = (kind === "daily") ? (done ? "å·²å®Œæˆ" : "æœªå®Œæˆ") : `é€²åº¦ ${prog}`;

                // daily ä»»å‹™æ‰é¡¯ç¤ºã€Œå®Œæˆ/å–æ¶ˆå®Œæˆã€æŒ‰éˆ•
                const actionHTML = (kind === "daily")
                    ? `
        <div style="margin-top:10px; display:flex; gap:8px;">
            <button
            type="button"
            class="daily-toggle"
            data-id="${escapeHTML(q.id)}"
            style="padding:8px 10px; border-radius:12px;"
            >
            ${done ? "å–æ¶ˆå®Œæˆ" : "æ¨™è¨˜å®Œæˆ"}
            </button>
        </div>
        `
                    : "";

                // å®Œæˆç‹€æ…‹çš„è¦–è¦ºï¼ˆå¯è‡ªè¡Œèª¿ï¼‰
                if (kind === "daily" && done) {
                    el.style.opacity = "0.65";
                    el.style.borderStyle = "solid";
                }

                el.innerHTML = `
        <div class="title">${escapeHTML(q.title)}</div>
        <div class="desc">${escapeHTML(q.desc)}</div>
        <div class="meta">
        <span>${metaLeft}</span>
        <span>${escapeHTML(q.rewardText || q.reward || "")}</span>
        </div>
        ${actionHTML}
    `;

                return el;
            }


            function getQuests() {
                state.quests.daily = pickDailyQuests().map(q => ({ ...q, done: false, paid: false }));
                // bounty can spawn based on hp
                state.quests.bounty = maybeSpawnBounty();

                saveState();
                renderBoard();
                renderHUD();
                toast("ğŸ“œ ä»Šæ—¥ä»»å‹™å·²å¼µè²¼ã€‚");
            }

            function reportComplete() {
                syncStateFromInputs();

                // Prevent double-report on same input (simple hash)
                const hash = JSON.stringify(state.today);
                if (hash === state.lastReportHash) {
                    toast("ä½ å‰›å‰›å·²å›å ±éåŒæ¨£å…§å®¹ã€‚");
                    return;
                }

                // XP gain
                const gainedXP = xpFromToday(state.today);
                state.xp += gainedXP;

                // heal from correct actions (NOT the end-of-day penalty)
                const heal = hpHealFromActions(state.today);
                state.hp = clampInt(state.hp + heal, 0, 100);

                // update ongoing chain progress (structure I uses backtest count)
                if (state.quests.ongoing?.id === "chain-structure-1") {
                    state.quests.ongoing.progress += state.today.bt;
                    if (state.quests.ongoing.progress >= state.quests.ongoing.target) {
                        // reward
                        state.xp += 40;
                        state.hp = clampInt(state.hp + 20, 0, 100);
                        toast("ğŸ§©ã€Šçµæ§‹ç†è§£ Iã€‹å®Œæˆï¼+40 XP / +20 HP");
                        // reset to next chain (simple)
                        state.quests.ongoing = {
                            id: "chain-errors-1",
                            title: "ğŸ§©ã€ŠéŒ¯èª¤åˆ†é¡ Iã€‹",
                            desc: "æ•´ç† 10 ç­†ã€éŒ¯èª¤åŸå› ã€ï¼ˆæœ¬ Demo ç”¨ï¼šå›æ¸¬æ»¿ 10 ç­†å³ç®— 1ï¼‰ã€‚",
                            target: 10,
                            progress: 0,
                            reward: "å®Œæˆï¼š+30 XP",
                        };
                    }
                } else if (state.quests.ongoing?.id === "chain-errors-1") {
                    // For demo: each 10 backtests counts as 1 progress unit
                    state.quests.ongoing.progress += Math.floor(state.today.bt / 10);
                    if (state.quests.ongoing.progress >= state.quests.ongoing.target) {
                        state.xp += 30;
                        toast("ğŸ§©ã€ŠéŒ¯èª¤åˆ†é¡ Iã€‹å®Œæˆï¼+30 XP");
                        // loop back
                        state.quests.ongoing = defaultState().quests.ongoing;
                    }
                }

                state.lastReportHash = hash;

                // level up check (refills HP on each level)
                tryLevelUp();

                saveState();
                renderBoard();
                renderHUD();
                toast(`âœ… å›å ±å®Œæˆï¼š+${gainedXP} XPï¼Œå›è¡€ +${heal} HPï¼ˆè‹¥æœ‰ï¼‰ã€‚`);
            }

            function endDay() {
                syncStateFromInputs();

                // Apply daily penalties
                const d = hpDeltaEndOfDay(state.today);
                state.hp = clampInt(state.hp + d, 0, 100);
                state.dayCount += 1;

                // bounty progress simulation: if bounty is fog, count a day where bt>=1
                if (state.quests.bounty?.id === "bounty-fog") {
                    if (state.today.bt >= 1) state.quests.bounty.progress += 1;
                    if (state.quests.bounty.progress >= state.quests.bounty.target) {
                        // bounty reward: hp full + 25 xp (as per spec)
                        state.hp = 100;
                        state.xp += 25;
                        toast("â˜ ï¸ è¨ä¼å®Œæˆï¼šã€æ‡¶æƒ°ä¹‹éœ§ã€å·²é©…æ•£ã€‚HP å›æ»¿ +25 XP");
                        state.quests.bounty = null;
                    }
                }

                // reset today inputs
                state.today = { bt: 0, live: "none", emo: false };
                state.lastReportHash = "";

                // if hp low, maybe spawn bounty
                if (!state.quests.bounty) state.quests.bounty = maybeSpawnBounty();

                // if HP hits 0, enforce penalty suggestion (A or C)
                if (state.hp === 0) {
                    toast("â˜ ï¸ HP æ­¸é›¶ï¼šæ˜å¤©å¿…é ˆåŸ·è¡Œã€æ™‚é–“å‹ 30â€“60 åˆ†é˜ã€æˆ–ã€å‰å¥ªå‹ 24 å°æ™‚ã€å…¶ä¸€ã€‚");
                } else {
                    toast(`ğŸŒ™ çµæŸä»Šæ—¥ï¼šHP ${d}ï¼ˆæ‰£è¡€/æƒ…ç·’å–®/æ²’å›æ¸¬ï¼‰ã€‚`);
                }
                state.quests.daily = [];
                saveState();
                syncInputsFromState();
                renderBoard();
                renderHUD();
            }

            function resetAll() {
                if (!confirm("ç¢ºå®šè¦é‡ç½®å­˜æª”å—ï¼Ÿï¼ˆç­‰ç´š/XP/HP æœƒæ­¸é›¶ï¼‰")) return;
                state = defaultState();
                saveState();
                syncInputsFromState();
                renderBoard();
                renderHUD();
                toast("å·²é‡ç½®ã€‚é‡æ–°é–‹å§‹ã€‚");
            }

            function updateBacktest(delta) {
                const cur = clampInt(btCount.value, 0, 9999);
                const next = Math.max(0, cur + delta);
                btCount.value = next;

                // è®“ä½ åŸæœ¬çš„ change ç›£è½åƒåˆ°æ›´æ–°
                btCount.dispatchEvent(new Event("change", { bubbles: true }));
            }

            /** ---------- Utils ---------- */
            function clampInt(v, min, max) {
                const n = Number.parseInt(v, 10);
                if (Number.isNaN(n)) return min;
                return Math.max(min, Math.min(max, n));
            }

            function shuffle(arr) {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            }

            function escapeHTML(s) {
                return String(s).replace(/[&<>"']/g, c => ({
                    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
                }[c]));
            }

            function toast(msg) {
                // Minimal toast using alert-like, but non-blocking
                const t = document.createElement("div");
                t.textContent = msg;
                t.style.position = "fixed";
                t.style.left = "50%";
                t.style.bottom = "16px";
                t.style.transform = "translateX(-50%)";
                t.style.background = "rgba(0,0,0,.55)";
                t.style.border = "1px solid rgba(255,255,255,.12)";
                t.style.padding = "10px 12px";
                t.style.borderRadius = "14px";
                t.style.boxShadow = "0 18px 40px rgba(0,0,0,.55)";
                t.style.backdropFilter = "blur(8px)";
                t.style.zIndex = 9999;
                t.style.maxWidth = "92vw";
                t.style.fontSize = "13px";
                document.body.appendChild(t);
                setTimeout(() => t.style.opacity = "0", 2200);
                setTimeout(() => t.remove(), 2600);
            }

            /** ---------- Wire ---------- */
            emoWrap.addEventListener("click", (e) => {
                if (e.target.tagName.toLowerCase() !== "input") emoTrade.checked = !emoTrade.checked;
            });

            [btCount, liveNote, emoTrade].forEach(el => {
                el.addEventListener("change", () => {
                    syncStateFromInputs();
                    saveState();
                    renderHUD();
                });
            });

            btnGetQuests.addEventListener("click", getQuests);
            dailySlot.addEventListener("click", (e) => {
                const btn = e.target.closest(".daily-toggle");
                if (!btn) return;

                const id = btn.dataset.id;
                if (!id) return;

                const q = state.quests.daily.find(x => x.id === id);
                if (!q) return;

                q.done = !q.done;
                if (q.done && !q.paid) {
                    state.xp += (q.xpReward ?? 0);
                    state.hp = clampInt(state.hp + (q.hpReward ?? 0), 0, 100);
                    q.paid = true;
                    tryLevelUp();
                }

                saveState();
                renderBoard();
                renderHUD(); // å¯é¸ï¼šä½ å¦‚æœæƒ³ NPC å°è©ä¹Ÿæ›´æ–°
            });
            btnReport.addEventListener("click", reportComplete);
            btnEndDay.addEventListener("click", endDay);
            btnReset.addEventListener("click", resetAll);
            btMinus.addEventListener("click", () => updateBacktest(-1));
            btPlus.addEventListener("click", () => updateBacktest(+1));

            // init
            syncInputsFromState();
            renderBoard();
            renderHUD();

        })();
    </script>
</body>

</html>